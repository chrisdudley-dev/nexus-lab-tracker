#!/usr/bin/env bash
set -euo pipefail

# Allow emergency bypass:
#   NEXUS_SKIP_PREPUSH=1 git push
if [[ "${NEXUS_SKIP_PREPUSH:-}" == "1" ]]; then
  exit 0
fi

remote_name="${1:-}"
remote_url="${2:-}"

need_check=0

# stdin lines are: <local_ref> <local_sha> <remote_ref> <remote_sha>
while read -r local_ref local_sha remote_ref remote_sha; do
  # Skip deletions
  if [[ "$local_sha" == "0000000000000000000000000000000000000000" ]]; then
    continue
  fi
  if [[ "$remote_ref" == "refs/heads/main" ]]; then
    need_check=1
  fi
done

if [[ "$need_check" -eq 0 ]]; then
  exit 0
fi

echo "pre-push: main push detected; running core regressions..."
if [[ ! -x "./scripts/regress_core.sh" ]]; then
  echo "pre-push ERROR: ./scripts/regress_core.sh missing or not executable" >&2
  exit 1
fi

./scripts/regress_core.sh
echo "pre-push: OK"
